{% extends "base.html" %}

{% block title %}Replay â€” {{ session_id }}{% endblock %}
{% block page_title %}Session Replay{% endblock %}

{% block content %}
<div class="card" style="margin-bottom:12px">
    <div class="filter-bar" style="padding:0;justify-content:space-between">
        <a href="/sessions" class="btn" style="gap:6px">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
            Back to Sessions
        </a>
        <span class="badge" id="sessionMeta">Loading...</span>
    </div>
</div>

<!-- Player Container -->
<div class="card" id="playerCard">
    <!-- Screen Display -->
    <div id="screenContainer" style="position:relative;background:#0a0a0a;border-radius:8px 8px 0 0;overflow:hidden;min-height:300px;display:flex;align-items:center;justify-content:center">
        <img id="screenImage" src="" alt="Session frame" style="max-width:100%;max-height:60vh;display:none">
        <div id="screenPlaceholder" style="color:var(--text-secondary);font-size:14px">Loading session...</div>
        <!-- Mouse cursor overlay -->
        <div id="cursorOverlay" style="position:absolute;width:12px;height:12px;border-radius:50%;background:rgba(255,59,48,0.8);border:2px solid #fff;pointer-events:none;display:none;transform:translate(-50%,-50%);transition:left 0.05s,top 0.05s;z-index:10"></div>
        <!-- Click ripple -->
        <div id="clickRipple" style="position:absolute;width:24px;height:24px;border-radius:50%;border:2px solid rgba(255,59,48,0.9);pointer-events:none;display:none;transform:translate(-50%,-50%);z-index:11"></div>
        <!-- Keystroke overlay -->
        <div id="keystrokeOverlay" style="position:absolute;bottom:12px;left:12px;right:12px;background:rgba(0,0,0,0.75);color:#fff;font-family:var(--font-mono);font-size:13px;padding:8px 12px;border-radius:6px;display:none;max-height:60px;overflow:hidden;word-break:break-all;z-index:10"></div>
        <!-- Window title overlay -->
        <div id="windowOverlay" style="position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.6);color:var(--text-secondary);font-size:11px;padding:4px 10px;border-radius:4px;display:none;z-index:10"></div>
    </div>

    <!-- Timeline Controls -->
    <div style="background:var(--bg-secondary);border-radius:0 0 8px 8px;padding:12px 16px">
        <!-- Scrub Bar -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span id="currentTime" style="font-family:var(--font-mono);font-size:12px;color:var(--text-secondary);min-width:44px">0:00</span>
            <input type="range" id="scrubBar" min="0" max="100" value="0" step="0.1"
                   style="flex:1;accent-color:var(--accent-blue);cursor:pointer;height:6px">
            <span id="totalTime" style="font-family:var(--font-mono);font-size:12px;color:var(--text-secondary);min-width:44px">0:00</span>
        </div>
        <!-- Buttons -->
        <div style="display:flex;align-items:center;gap:8px">
            <button class="btn" id="btnPlay" title="Play / Pause">
                <svg id="iconPlay" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                <svg id="iconPause" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display:none"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
            </button>
            <button class="btn" id="btnStop" title="Stop">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
            </button>
            <div style="width:1px;height:20px;background:var(--border-primary)"></div>
            <button class="btn" id="btnPrev" title="Previous frame">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="19 20 9 12 19 4"/><line x1="5" y1="4" x2="5" y2="20"/></svg>
            </button>
            <button class="btn" id="btnNext" title="Next frame">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="5 4 15 12 5 20"/><line x1="19" y1="4" x2="19" y2="20"/></svg>
            </button>
            <div style="width:1px;height:20px;background:var(--border-primary)"></div>
            <label style="font-size:12px;color:var(--text-secondary)">Speed</label>
            <select id="speedSelect" class="form-select" style="width:auto;min-width:60px">
                <option value="0.25">0.25x</option>
                <option value="0.5">0.5x</option>
                <option value="1" selected>1x</option>
                <option value="2">2x</option>
                <option value="4">4x</option>
            </select>
            <div style="flex:1"></div>
            <span id="frameInfo" style="font-size:11px;color:var(--text-tertiary);font-family:var(--font-mono)">--</span>
        </div>
    </div>
</div>

<!-- Event Log (collapsible) -->
<details class="card" style="padding:0">
    <summary class="card-header" style="cursor:pointer;padding:12px 16px">
        <h2 class="card-title" style="font-size:14px">Event Log</h2>
        <span class="badge" id="eventCountBadge">--</span>
    </summary>
    <div style="max-height:300px;overflow-y:auto;padding:0 16px 12px">
        <table class="data-table" style="font-size:12px">
            <thead><tr><th>Time</th><th>Type</th><th>Data</th></tr></thead>
            <tbody id="eventLogBody"></tbody>
        </table>
    </div>
</details>

<style>
#scrubBar { -webkit-appearance: none; appearance: none; background: var(--border-primary); border-radius: 3px; outline: none; }
#scrubBar::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: var(--accent-blue); cursor: pointer; }
#scrubBar::-moz-range-thumb { width: 14px; height: 14px; border-radius: 50%; background: var(--accent-blue); cursor: pointer; border: none; }
@keyframes ripple { 0% { transform: translate(-50%,-50%) scale(1); opacity:1; } 100% { transform: translate(-50%,-50%) scale(3); opacity:0; } }
.click-ripple-anim { animation: ripple 0.4s ease-out forwards; }
</style>
{% endblock %}

{% block scripts %}
<script>
    window.__SESSION_ID__ = {{ session_id | tojson }};
</script>
<script src="/static/js/session-replay.js"></script>
{% endblock %}
